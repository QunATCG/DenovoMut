rm(list = ls())
setwd("/Users/liqun/Desktop/T4Data/7_TADA/")
source("./src/TADA.v.1.2.R")
tada.file = "Denovogene_Mut_TADA.txt"
tada.data=read.table(tada.file,header=T)
n.family = 473
n = data.frame(dn=n.family, ca=NA, cn=NA)
sample.counts <- list(cls1=n, cls2=n)

# dn.cls1(lof)
# dn.cls2(mis)

cls1.counts=data.frame(dn=tada.data$dn.cls1, ca=NA, cn=NA)
rownames(cls1.counts)=tada.data$gene.id
cls2.counts=data.frame(dn=tada.data$dn.cls2, ca=NA, cn=NA)
rownames(cls2.counts)=tada.data$gene.id
tada.counts=list(cls1=cls1.counts,cls2=cls2.counts)

mu=data.frame(cls1=tada.data$mut.cls1,cls2=tada.data$mut.cls2)
denovo.only=data.frame(cls1=TRUE,cls2=TRUE)


# risk genes
pi=419/17226

# cls1-gamma.mean.dn-lof
# num(lof-case) = 61
# num(lof-control) = 7
# num(syn-case) = 123
# num(syn-control) = 23

cls1_位.dn_lof = (61*23)/(7*123) 

# cls2-gamma.mean.dn-mis
# num(mis-case) = 294
# num(mis-control) = 39
cls2_位.dn_mis = (294*23)/(39*123)

cls1_gamma.mean.dn_lof= 1+((cls1_位.dn_lof-1)/pi)
cls2_gamma.mean.dn_mis= 1+((cls2_位.dn_mis-1)/pi)


cls1= data.frame(gamma.mean.dn=cls1_gamma.mean.dn_lof,beta.dn=0.2,gamma.mean.CC=NA,beta.CC=NA,rho1=NA,nu1=NA,rho0=NA,nu0=NA)
cls2= data.frame(gamma.mean.dn= cls2_gamma.mean.dn_mis,beta.dn=0.2,gamma.mean.CC=NA,beta.CC=NA,rho1=NA,nu1=NA,rho0=NA,nu0=NA)
hyperpar=list(cls1=cls1,cls2=cls2)

re.TADA <- do.call(cbind.data.frame, TADA(tada.counts=tada.counts, sample.counts=sample.counts, mu=mu, hyperpar=hyperpar, denovo.only=denovo.only))
re.TADA$qval=Bayesian.FDR(re.TADA$BF.total, pi0 = 0.95)
re.TADA.null=do.call(cbind.data.frame, TADAnull(tada.counts=tada.counts, sample.counts=sample.counts, mu=mu, hyperpar=hyperpar, denovo.only=denovo.only, nrep=1000))
re.TADA$pval=bayesFactor.pvalue(re.TADA$BF.total,re.TADA.null$BFnull.total)
hist(re.TADA$pval)

write.table(re.TADA,"re.TADA.txt",sep = "\t")
